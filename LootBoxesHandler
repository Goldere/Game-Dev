-- Services
local RS = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")

-- Variables
local plr = game.Players.LocalPlayer
local character = plr.Character or plr.CharacterAdded:Wait()
local cratesScrollingFrame = script.Parent.ScrollingFrame.CratesFrame
local gui = plr.PlayerGui.MainGui
local parentImageLabel = script.Parent.CrateOpenWindow.ImageLabel.ImageBar

-- Events
local CheckIsItemPurchasable = RS.RemoteFunctions.CheckIsItemPurchasable
local CrateOpened = RS.Events.CrateOpened

-- Tweens
local RewardsOpenTween = TweenService:Create(plr.PlayerGui.MainGui.ChromaCrateRewardWindow, TweenInfo.new(0.4, Enum.EasingStyle.Sine, Enum.EasingDirection.Out),
	{Size = UDim2.fromScale(1.2, 1.2)})
local RewardsCloseTween = TweenService:Create(plr.PlayerGui.MainGui.ChromaCrateRewardWindow, TweenInfo.new(0.4, Enum.EasingStyle.Sine, Enum.EasingDirection.In),
	{Size = UDim2.fromScale(0, 0)})


-- Chroma images
local ChromaImages = {
	DanceFloorCrate = {BlackAndWhiteDanceFloor = "rbxassetid://18103790012",
		EmeraldDanceFloor = "rbxassetid://18103806909",
		RoseQuartzDanceFloor = "rbxassetid://18103802471",
		OrangeAndTurquoiseDanceFloor = "rbxassetid://18103799758",
		SkyBlueAndDarkOrangeDanceFloor = "rbxassetid://18103805048",
		RedAndGreenDanceFloor = "rbxassetid://18103795542",},
	CandlelitCrate = {CatseyeCandlelit = "rbxassetid://18122096129",
		PearlCandlelit = "rbxassetid://18122093970",
		PrismCandlelit = "rbxassetid://18122097911",
		RubyCandlelit = "rbxassetid://18122088585",
		SapphireCandlelit = "rbxassetid://18122091261",
		EmeraldCandlelit = "rbxassetid://18122101343"},
}

-- Drop chances
local DanceFloorCrate = {
	["BlackAndWhiteDanceFloor"] = 10;
	["OrangeAndTurquoiseDanceFloor"] = 190;
	["RoseQuartzDanceFloor"] = 800;
	["SkyBlueAndDarkOrangeDanceFloor"] = 2000;
	["RedAndGreenDanceFloor"] = 3000;
	["EmeraldDanceFloor"] = 4000;
}

local CandlelitCrate = {
	["CatseyeCandlelit"] = 800;
	["PearlCandlelit"] = 2000;
	["RubyCandlelit"] = 190;
	["PrismCandlelit"] = 10;
	["SapphireCandlelit"] = 4000;
	["EmeraldCandlelit"] = 3000;
}



local function openCrate(crateName)

	local raritiesTable
	
	-- Determine what chances we are handling
	if crateName == "DanceFloorCrate" then
		raritiesTable = DanceFloorCrate
	elseif crateName == "CandlelitCrate" then
		raritiesTable = CandlelitCrate
	end
	
	local unboxedChroma
	local randomNumber = math.random(1,10000)
	local counter = 0
	
	-- Determine what rarity was unboxed
	for rarity, weight in pairs(raritiesTable) do
		counter += weight
		if randomNumber <= counter then
			unboxedChroma = rarity
			break
		end
	end
	
	CrateOpened:FireServer(crateName, unboxedChroma)
	
	local parentImageLabelSizeX = 10174 -- Width of the parent image label

	-- Define the properties of the child image labels
	local childImageLabelSizeX = 87     -- Width of each child image label
	local childImageSpacing = 10        -- Spacing between each child image label
	
	-- Calculate the total width of each child image label including spacing
	local totalChildWidth = childImageLabelSizeX + childImageSpacing

	-- Calculate how many child image labels can fit into the parent image label
	local numChildLabels = math.floor(parentImageLabelSizeX / totalChildWidth)
	
	--Create a table with keys from the crate sub table
	local keys = {}
	
	for key in pairs(ChromaImages[crateName]) do
		table.insert(keys, key)
	end
	
	local imagebar = script.Parent.CrateOpenWindow.ImageLabel.ImageBar:GetChildren()
	
	-- Loop to insert child image labels
	for i = 0, numChildLabels - 1 do
		--Pick a random key
		local randomIndex = math.random(#keys)
		local randomKey = keys[randomIndex]
		
		imagebar[i + 1].Image = ChromaImages[crateName][randomKey]
	end
	
	script.Parent.CrateOpenWindow.ImageLabel.ImageBar.First.Image = ChromaImages[crateName][unboxedChroma]
	
	task.wait(1)
	
	script.Parent.CrateOpenWindow.ImageLabel.ImageBar:TweenPosition(UDim2.new(-9.68, 0,0.043, 0), "Out", "Sine", 5)

	task.wait(0.3)
	
	--script.Parent.Parent.Sounds.SS_Treasure_Chest_Open:Play()
	
	task.wait(6)
	
	plr.PlayerGui.MainGui.ChromaCrateRewardWindow.ImageLabel.ImageLabel.Image = ChromaImages[crateName][unboxedChroma]
	
	plr.PlayerGui.MainGui.ChromaCrateRewardWindow.Visible = true
	
	script.Parent.CrateOpenWindow.Visible = false
	
	if plr.OwnedItems[unboxedChroma .. "Owned"].Value == true then
		plr.PlayerGui.MainGui.ChromaCrateRewardWindow.RewardText.Text = "Chroma owned, Crate refunded."
	else
		plr.PlayerGui.MainGui.ChromaCrateRewardWindow.RewardText.Text = "New Chroma Unlocked!"
	end

	RewardsOpenTween:Play()
	
	task.wait(0.4)
	
	script.Parent.Parent.Sounds.reward_screen_reveal_day5:Play()
	
	task.wait(5)
	
	RewardsCloseTween:Play()
	
	task.wait(0.7)

	plr.PlayerGui.MainGui.ChromaCrateRewardWindow.Visible = false
	
	script.Parent.CrateOpenWindow.ImageLabel.ImageBar.Position = UDim2.new(-0, 0,0.043, 0)
	
	-- Turn the store window visible
	for i, v in pairs(script.Parent:GetChildren()) do
		if not v:IsA("LocalScript") and not v:IsA("Frame") and v.Name ~= "LockText"
			and v.Name ~= "LockImage" and v.Name ~= "LockBackground" then
			v.Visible = true
		end
	end
end

-- Connect the button clicks to the openCrate function
for _, v in ipairs(cratesScrollingFrame:GetChildren()) do
	local imageButton = v:FindFirstChild("ImageButton")
	if imageButton then
		imageButton.MouseButton1Click:Connect(function()
			local result = CheckIsItemPurchasable:InvokeServer(v.Name, false, false, false, false, true)
			if result then
				script.Parent.CrateOpenWindow.Visible = true
				for i, v in pairs(script.Parent:GetChildren()) do
					if not v:IsA("LocalScript") and not v:IsA("Frame") and v.Name ~= "LockText"
						and v.Name ~= "LockImage" and v.Name ~= "LockBackground"
					then
						v.Visible = false
					end
				end
				openCrate(v.Name)
			end
		end)
	end
end

-- Check if the player's level is greater than or equal to 1
plr.leaderstats.Level.Changed:Connect(function()
	if plr.leaderstats.Level.Value >= 1 then -- Make window visible
		script.Parent.LockText.Visible = false
		script.Parent.LockImage.Visible = false
		script.Parent.LockBackground.Visible = false
	end
end)
